#@package _global_

defaults:
  - /data: pastis_subpatched
  - /model: prithvi_segmentation
  - override /plugins: mixed_precision

tags: ["finetunning", "prithvi_segmentation"]

_indices: &var_data_transform_indices [0, 1, 2, 7, 8, 9]
_shape: &var_data_transform_shape [-1, 128, 128]
_num_frames: &var_num_frames 3
_num_classes: &var_num_classes 20
_monitor_metric: &var_monitor_metric "val/iou"

callbacks:
  model_checkpoint:
    monitor: *var_monitor_metric
    mode: "max"
  early_stopping:
    monitor: *var_monitor_metric
    mode: "max"

data:
  train:
    subpatch_size: *var_num_frames
    transforms:
      _target_: src.data.transforms.loose_bind_transforms
      transforms:
        - _target_: src.data.transforms.FromNumpy
          _partial_: True
        - _target_: torchvision.transforms.Normalize
          _partial_: True
        - _target_: src.data.transforms.Transpose
          _partial_: True
          dim0: 0
          dim1: 1
        - _target_: src.data.transforms.Take
          _partial_: True
          indices: *var_data_transform_indices
          dim: 0
  val:
    subpatch_size: *var_num_frames
    transforms:
      _target_: src.data.transforms.loose_bind_transforms
      transforms:
        - _target_: src.data.transforms.FromNumpy
          _partial_: True
        - _target_: torchvision.transforms.Normalize
          _partial_: True
        - _target_: src.data.transforms.Transpose
          _partial_: True
          dim0: 0
          dim1: 1
        - _target_: src.data.transforms.Take
          _partial_: True
          indices: *var_data_transform_indices
          dim: 0
  test:
    subpatch_size: *var_num_frames
    transforms:
      _target_: src.data.transforms.loose_bind_transforms
      transforms:
        - _target_: src.data.transforms.FromNumpy
          _partial_: True
        - _target_: torchvision.transforms.Normalize
          _partial_: True
        - _target_: src.data.transforms.Transpose
          _partial_: True
          dim0: 0
          dim1: 1
        - _target_: src.data.transforms.Take
          _partial_: True
          indices: *var_data_transform_indices
          dim: 0

model:
  net:
    img_size: 128
    num_classes: *var_num_classes
    num_frames: *var_num_frames
  criterion:
    _target_: torch.nn.CrossEntropyLoss
  scheduler:
    _target_: torch.optim.lr_scheduler.StepLR
    _partial_: True
    step_size: 3
    gamma: 0.5
  class_weight_strategy: "per-batch"

trainer:
  max_epochs: 60
  gradient_clip_val: 0.1
    